# 384 Well Conversion Utility
# This script takes a vertical column format file exported from FloJo for 384 wells
# and transforms it into a column file format where the well positions have been translated from 384-well to 96-well, multi-plate format
#
# by Mark Evans
# 
# Created 08.27.2013
#

WELLS = {'HORIZ':{1:'A01',2:'A02',3:'A03',4:'A04',5:'A05',6:'A06',7:'A07',8:'A08',9:'A09',10:'A10',11:'A11',12:'A12',
                  13:'B01',14:'B02',15:'B03',16:'B04',17:'B05',18:'B06',19:'B07',20:'B08',21:'B09',22:'B10',23:'B11',24:'B12',
                  25:'C01',26:'C02',27:'C03',28:'C04',29:'C05',30:'C06',31:'C07',32:'C08',33:'C09',34:'C10',35:'C11',36:'C12',
                  37:'D01',38:'D02',39:'D03',40:'D04',41:'D05',42:'D06',43:'D07',44:'D08',45:'D09',46:'D10',47:'D11',48:'D12',
                  49:'E01',50:'E02',51:'E03',52:'E04',53:'E05',54:'E06',55:'E07',56:'E08',57:'E09',58:'E10',59:'E11',60:'E12',
                  61:'F01',62:'F02',63:'F03',64:'F04',65:'F05',66:'F06',67:'F07',68:'F08',69:'F09',70:'F10',71:'F11',72:'F12',
                  73:'G01',74:'G02',75:'G03',76:'G04',77:'G05',78:'G06',79:'G07',80:'G08',81:'G09',82:'G10',83:'G11',84:'G12',
                  85:'H01',86:'H02',87:'H03',88:'H04',89:'H05',90:'H06',91:'H07',92:'H08',93:'H09',94:'H10',95:'H11',96:'H12'},
         'VERT':{   1:1,2:13,3:25,4:37,5:49,6:61,7:73,8:85,
                    9:2,10:14,11:26,12:38,13:50,14:62,15:74,16:86,
                    17:3,18:15,19:27,20:39,21:51,22:63,23:75,24:87,
                    25:4,26:16,27:28,28:40,29:52,30:64,31:76,32:88,
                    33:5,34:17,35:29,36:41,37:53,38:65,39:77,40:89,
                    41:6,42:18,43:30,44:42,45:54,46:66,47:78,48:90,
                    49:7,50:19,51:31,52:43,53:55,54:67,55:79,56:91,
                    57:8,58:20,59:32,60:44,61:56,62:68,63:80,64:92,
                    65:9,66:21,67:33,68:45,69:57,70:69,71:81,72:93,
                    73:10,74:22,75:34,76:46,77:58,78:70,79:82,80:94,
                    81:11,82:23,83:35,84:47,85:59,86:71,87:83,88:95,
                    89:12,90:24,91:36,92:48,93:60,94:72,95:84,96:96}}

# For Quad-well layout 384-well plates
# {HORIZ ABS pos:(394 WELL-H, 96-plates num, 96-horiz-pos, 96-horiz-well)}
WELLS_384 = {        1:('A01','P1',1,'A01'),2:('A02','P2',1,'A01'),3:('A03','P1',2,'A02'),4:('A04','P2',2,'A02'),5:('A05','P1',3,'A03'),6:('A06','P2',3,'A03'),7:('A07','P1',4,'A04'),8:('A08','P2',4,'A04'),9:('A09','P1',5,'A05'),10:('A10','P2',5,'A05'),
                    11:('A11','P1',6,'A06'),12:('A12','P2',6,'A06'),13:('A13','P1',7,'A07'),14:('A14','P2',7,'A07'),15:('A15','P1',8,'A08'),16:('A16','P2',8,'A08'),17:('A17','P1',9,'A09'),18:('A18','P2',9,'A09'),19:('A19','P1',10,'A10'),20:('A20','P2',10,'A10'),
                    21:('A21','P1',11,'A11'),22:('A22','P2',11,'A11'),23:('A23','P1',12,'A12'),24:('A24','P2',12,'A12'),25:('B01','P3',1,'A01'),26:('B02','P4',1,'A01'),27:('B03','P3',2,'A02'),28:('B04','P4',2,'A02'),29:('B05','P3',3,'A03'),30:('B06','P4',3,'A03'),
                    31:('B07','P3',4,'A04'),32:('B08','P4',4,'A04'),33:('B09','P3',5,'A05'),34:('B10','P4',5,'A05'),35:('B11','P3',6,'A06'),36:('B12','P4',6,'A06'),37:('B13','P3',7,'A07'),38:('B14','P4',7,'A07'),39:('B15','P3',8,'A08'),40:('B16','P4',8,'A08'),
                    41:('B17','P3',9,'A09'),42:('B18','P4',9,'A09'),43:('B19','P3',10,'A10'),44:('B20','P4',10,'A10'),45:('B21','P3',11,'A11'),46:('B22','P4',11,'A11'),47:('B23','P3',12,'A12'),48:('B24','P4',12,'A12'),49:('C01','P1',13,'B01'),50:('C02','P2',13,'B01'),
                    51:('C03','P1',14,'B02'),52:('C04','P2',14,'B02'),53:('C05','P1',15,'B03'),54:('C06','P2',15,'B03'),55:('C07','P1',16,'B04'),56:('C08','P2',16,'B04'),57:('C09','P1',17,'B05'),58:('C10','P2',17,'B05'),59:('C11','P1',18,'B06'),60:('C12','P2',18,'B06'),
                    61:('C13','P1',19,'B07'),62:('C14','P2',19,'B07'),63:('C15','P1',20,'B08'),64:('C16','P2',20,'B08'),65:('C17','P1',21,'B09'),66:('C18','P2',21,'B09'),67:('C19','P1',22,'B10'),68:('C20','P2',22,'B10'),69:('C21','P1',23,'B11'),70:('C22','P2',23,'B11'),
                    71:('C23','P1',24,'B12'),72:('C24','P2',24,'B12'),73:('D01','P3',13,'B01'),74:('D02','P4',13,'B01'),75:('D03','P3',14,'B02'),76:('D04','P4',14,'B02'),77:('D05','P3',15,'B03'),78:('D06','P4',15,'B03'),79:('D07','P3',16,'B04'),80:('D08','P4',16,'B04'),
                    81:('D09','P3',17,'B05'),82:('D10','P4',17,'B05'),83:('D11','P3',18,'B06'),84:('D12','P4',18,'B06'),85:('D13','P3',19,'B07'),86:('D14','P4',19,'B07'),87:('D15','P3',20,'B08'),88:('D16','P4',20,'B08'),89:('D17','P3',21,'B09'),90:('D18','P4',21,'B09'),
                    91:('D19','P3',22,'B10'),92:('D20','P4',22,'B10'),93:('D21','P3',23,'B11'),94:('D22','P4',23,'B11'),95:('D23','P3',24,'B12'),96:('D24','P4',24,'B12'),97:('E01','P1',25,'C01'),98:('E02','P2',25,'C01'),99:('E03','P1',26,'C02'),100:('E04','P2',26,'C02'),
                    101:('E05','P1',27,'C03'),102:('E06','P2',27,'C03'),103:('E07','P1',28,'C04'),104:('E08','P2',28,'C04'),105:('E09','P1',29,'C05'),106:('E10','P2',29,'C05'),107:('E11','P1',30,'C06'),108:('E12','P2',30,'C06'),109:('E13','P1',31,'C07'),110:('E14','P2',31,'C07'),
                    111:('E15','P1',32,'C08'),112:('E16','P2',32,'C08'),113:('E17','P1',33,'C09'),114:('E18','P2',33,'C09'),115:('E19','P1',34,'C10'),116:('E20','P2',34,'C10'),117:('E21','P1',35,'C11'),118:('E22','P2',35,'C11'),119:('E23','P1',36,'C12'),120:('E24','P2',36,'C12'),
                    121:('F01','P3',25,'C01'),122:('F02','P4',25,'C01'),123:('F03','P3',26,'C02'),124:('F04','P4',26,'C02'),125:('F05','P3',27,'C03'),126:('F06','P4',27,'C03'),127:('F07','P3',28,'C04'),128:('F08','P4',28,'C04'),129:('F09','P3',29,'C05'),130:('F10','P4',29,'C05'),
                    131:('F11','P3',30,'C06'),132:('F12','P4',30,'C06'),133:('F13','P3',31,'C07'),134:('F14','P4',31,'C07'),135:('F15','P3',32,'C08'),136:('F16','P4',32,'C08'),137:('F17','P3',33,'C09'),138:('F18','P4',33,'C09'),139:('F19','P3',34,'C10'),140:('F20','P4',34,'C10'),
                    141:('F21','P3',35,'C11'),142:('F22','P4',35,'C11'),143:('F23','P3',36,'C12'),144:('F24','P4',36,'C12'),145:('G01','P1',37,'D01'),146:('G02','P2',37,'D01'),147:('G03','P1',38,'D02'),148:('G04','P2',38,'D02'),149:('G05','P1',39,'D03'),150:('G06','P2',39,'D03'),
                    151:('G07','P1',40,'D04'),152:('G08','P2',40,'D04'),153:('G09','P1',41,'D05'),154:('G10','P2',41,'D05'),155:('G11','P1',42,'D06'),156:('G12','P2',42,'D06'),157:('G13','P1',43,'D07'),158:('G14','P2',43,'D07'),159:('G15','P1',44,'D08'),160:('G16','P2',44,'D08'),
                    161:('G17','P1',45,'D09'),162:('G18','P2',45,'D09'),163:('G19','P1',46,'D10'),164:('G20','P2',46,'D10'),165:('G21','P1',47,'D11'),166:('G22','P2',47,'D11'),167:('G23','P1',48,'D12'),168:('G24','P2',48,'D12'),169:('H01','P3',37,'D01'),170:('H02','P4',37,'D01'),
                    171:('H03','P3',38,'D02'),172:('H04','P4',38,'D02'),173:('H05','P3',39,'D03'),174:('H06','P4',39,'D03'),175:('H07','P3',40,'D04'),176:('H08','P4',40,'D04'),177:('H09','P3',41,'D05'),178:('H10','P4',41,'D05'),179:('H11','P3',42,'D06'),180:('H12','P4',42,'D06'),
                    181:('H13','P3',43,'D07'),182:('H14','P4',43,'D07'),183:('H15','P3',44,'D08'),184:('H16','P4',44,'D08'),185:('H17','P3',45,'D09'),186:('H18','P4',45,'D09'),187:('H19','P3',46,'D10'),188:('H20','P4',46,'D10'),189:('H21','P3',47,'D11'),190:('H22','P4',47,'D11'),
                    191:('H23','P3',48,'D12'),192:('H24','P4',48,'D12'),193:('I01','P1',49,'E01'),194:('I02','P2',49,'E01'),195:('I03','P1',50,'E02'),196:('I04','P2',50,'E02'),197:('I05','P1',51,'E03'),198:('I06','P2',51,'E03'),199:('I07','P1',52,'E04'),200:('I08','P2',52,'E04'),
                    201:('I09','P1',53,'E05'),202:('I10','P2',53,'E05'),203:('I11','P1',54,'E06'),204:('I12','P2',54,'E06'),205:('I13','P1',55,'E07'),206:('I14','P2',55,'E07'),207:('I15','P1',56,'E08'),208:('I16','P2',56,'E08'),209:('I17','P1',57,'E09'),210:('I18','P2',57,'E09'),
                    211:('I19','P1',58,'E10'),212:('I20','P2',58,'E10'),213:('I21','P1',59,'E11'),214:('I22','P2',59,'E11'),215:('I23','P1',60,'E12'),216:('I24','P2',60,'E12'),217:('J01','P3',49,'E01'),218:('J02','P4',49,'E01'),219:('J03','P3',50,'E02'),220:('J04','P4',50,'E02'),
                    221:('J05','P3',51,'E03'),222:('J06','P4',51,'E03'),223:('J07','P3',52,'E04'),224:('J08','P4',52,'E04'),225:('J09','P3',53,'E05'),226:('J10','P4',53,'E05'),227:('J11','P3',54,'E06'),228:('J12','P4',54,'E06'),229:('J13','P3',55,'E07'),230:('J14','P4',55,'E07'),
                    231:('J15','P3',56,'E08'),232:('J16','P4',56,'E08'),233:('J17','P3',57,'E09'),234:('J18','P4',57,'E09'),235:('J19','P3',58,'E10'),236:('J20','P4',58,'E10'),237:('J21','P3',59,'E11'),238:('J22','P4',59,'E11'),239:('J23','P3',60,'E12'),240:('J24','P4',60,'E12'),
                    241:('K01','P1',61,'F01'),242:('K02','P2',61,'F01'),243:('K03','P1',62,'F02'),244:('K04','P2',62,'F02'),245:('K05','P1',63,'F03'),246:('K06','P2',63,'F03'),247:('K07','P1',64,'F04'),248:('K08','P2',64,'F04'),249:('K09','P1',65,'F05'),250:('K10','P2',65,'F05'),
                    251:('K11','P1',66,'F06'),252:('K12','P2',66,'F06'),253:('K13','P1',67,'F07'),254:('K14','P2',67,'F07'),255:('K15','P1',68,'F08'),256:('K16','P2',68,'F08'),257:('K17','P1',69,'F09'),258:('K18','P2',69,'F09'),259:('K19','P1',70,'F10'),260:('K20','P2',70,'F10'),
                    261:('K21','P1',71,'F11'),262:('K22','P2',71,'F11'),263:('K23','P1',72,'F12'),264:('K24','P2',72,'F12'),265:('L01','P3',61,'F01'),266:('L02','P4',61,'F01'),267:('L03','P3',62,'F02'),268:('L04','P4',62,'F02'),269:('L05','P3',63,'F03'),270:('L06','P4',63,'F03'),
                    271:('L07','P3',64,'F04'),272:('L08','P4',64,'F04'),273:('L09','P3',65,'F05'),274:('L10','P4',65,'F05'),275:('L11','P3',66,'F06'),276:('L12','P4',66,'F06'),277:('L13','P3',67,'F07'),278:('L14','P4',67,'F07'),279:('L15','P3',68,'F08'),280:('L16','P4',68,'F08'),
                    281:('L17','P3',69,'F09'),282:('L18','P4',69,'F09'),283:('L19','P3',70,'F10'),284:('L20','P4',70,'F10'),285:('L21','P3',71,'F11'),286:('L22','P4',71,'F11'),287:('L23','P3',72,'F12'),288:('L24','P4',72,'F12'),289:('M01','P1',73,'G01'),290:('M02','P2',73,'G01'),
                    291:('M03','P1',74,'G02'),292:('M04','P2',74,'G02'),293:('M05','P1',75,'G03'),294:('M06','P2',75,'G03'),295:('M07','P1',76,'G04'),296:('M08','P2',76,'G04'),297:('M09','P1',77,'G05'),298:('M10','P2',77,'G05'),299:('M11','P1',78,'G06'),300:('M12','P2',78,'G06'),
                    301:('M13','P1',79,'G07'),302:('M14','P2',79,'G07'),303:('M15','P1',80,'G08'),304:('M16','P2',80,'G08'),305:('M17','P1',81,'G09'),306:('M18','P2',81,'G09'),307:('M19','P1',82,'G10'),308:('M20','P2',82,'G10'),309:('M21','P1',83,'G11'),310:('M22','P2',83,'G11'),
                    311:('M23','P1',84,'G12'),312:('M24','P2',84,'G12'),313:('N01','P3',73,'G01'),314:('N02','P4',73,'G01'),315:('N03','P3',74,'G02'),316:('N04','P4',74,'G02'),317:('N05','P3',75,'G03'),318:('N06','P4',75,'G03'),319:('N07','P3',76,'G04'),320:('N08','P4',76,'G04'),
                    321:('N09','P3',77,'G05'),322:('N10','P4',77,'G05'),323:('N11','P3',78,'G06'),324:('N12','P4',78,'G06'),325:('N13','P3',79,'G07'),326:('N14','P4',79,'G07'),327:('N15','P3',80,'G08'),328:('N16','P4',80,'G08'),329:('N17','P3',81,'G09'),330:('N18','P4',81,'G09'),
                    331:('N19','P3',82,'G10'),332:('N20','P4',82,'G10'),333:('N21','P3',83,'G11'),334:('N22','P4',83,'G11'),335:('N23','P3',84,'G12'),336:('N24','P4',84,'G12'),337:('O01','P1',85,'H01'),338:('O02','P2',85,'H01'),339:('O03','P1',86,'H02'),340:('O04','P2',86,'H02'),
                    341:('O05','P1',87,'H03'),342:('O06','P2',87,'H03'),343:('O07','P1',88,'H04'),344:('O08','P2',88,'H04'),345:('O09','P1',89,'H05'),346:('O10','P2',89,'H05'),347:('O11','P1',90,'H06'),348:('O12','P2',90,'H06'),349:('O13','P1',91,'H07'),350:('O14','P2',91,'H07'),
                    351:('O15','P1',92,'H08'),352:('O16','P2',92,'H08'),353:('O17','P1',93,'H09'),354:('O18','P2',93,'H09'),355:('O19','P1',94,'H10'),356:('O20','P2',94,'H10'),357:('O21','P1',95,'H11'),358:('O22','P2',95,'H11'),359:('O23','P1',96,'H12'),360:('O24','P2',96,'H12'),
                    361:('P01','P3',85,'H01'),362:('P02','P4',85,'H01'),363:('P03','P3',86,'H02'),364:('P04','P4',86,'H02'),365:('P05','P3',87,'H03'),366:('P06','P4',87,'H03'),367:('P07','P3',88,'H04'),368:('P08','P4',88,'H04'),369:('P09','P3',89,'H05'),370:('P10','P4',89,'H05'),
                    371:('P11','P3',90,'H06'),372:('P12','P4',90,'H06'),373:('P13','P3',91,'H07'),374:('P14','P4',91,'H07'),375:('P15','P3',92,'H08'),376:('P16','P4',92,'H08'),377:('P17','P3',93,'H09'),378:('P18','P4',93,'H09'),379:('P19','P3',94,'H10'),380:('P20','P4',94,'H10'),
                    381:('P21','P3',95,'H11'),382:('P22','P4',95,'H11'),383:('P23','P3',96,'H12'),
                    384:('P24','P4',96,'H12')}

# Get filename to parse, open files for reading and writing
filename = raw_input("what is the file to parse: ")

f1 = open(filename,'r')
f2 = open(filename[:-4]+".list.txt",'w')

plates = {}
plate = ""
ratio_pos = 0
ags = []

# Read in source file and parse
for line in f1.readlines():
    a = line.rstrip().split('\t')
    if a[0] == 'Sample': 
        ratio_pos = a.index('Ratio')    # Want to exclude this column, so need to know where it is
        ags = a[1:ratio_pos]            # Get list of antigens from the column headers
        for x in ags: plates[x] = {'P1':[],'P2':[],'P3':[],'P4':[]}     # Preload dictionary with four 96-well plates
    
    # Handle data lines    
    if a[0] != 'Sample' and a[0] != 'StdDev' and a[0] != 'Mean':
        b = int(a[0].split(':')[0])     # Get out 384 well abs pos index
        
        # Use zip to pair Antigen and value on the fly
        for val,ag in zip(a[1:ratio_pos],ags):
            plates[ag][WELLS_384[b][1]].append(val)

# Combine individual 96-well plates into single list organized by antigen
column_values =[]
merged_plates = {}
for ag in ags: 
    merged_plates[ag] = []
    for p in ('P1','P2','P3','P4'):
        merged_plates[ag].extend(plates[ag][p])

# Create list of tuples containing all values across the columns for writing
column_values = zip(*map(merged_plates.get, sorted(merged_plates)))

# Create output
f2.write('Sample \t'+'\t'.join(sorted(ags))+'\n')
c = 1
well_count = 1
plate_count = 1
for vals in column_values:
    if well_count > 96: 
        well_count = 1
        plate_count +=1
    # Using sample ID format from FACScan so XabTracker will be happy
    # e.g. 01A01 ... 96L: 01H12 ... 01: 02A01
    sample = str(well_count)+': 0'+str(plate_count)+WELLS['HORIZ'][well_count]
    f2.write(sample+'\t'+'\t'.join(list(vals))+'\n')
    c += 1
    well_count += 1

f1.close()
f2.close()